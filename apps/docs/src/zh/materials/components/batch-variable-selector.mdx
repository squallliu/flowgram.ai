import { SourceCode } from '@theme';
import { BasicStory } from 'components/form-materials/components/batch-variable-selector';

# BatchVariableSelector

BatchVariableSelector æ˜¯ä¸€ä¸ªç”¨äºé€‰æ‹©æ•°ç»„ç±»å‹å˜é‡çš„ç»„ä»¶ï¼Œå®ƒæ˜¯ [VariableSelector](./variable-selector) çš„å°è£…ç‰ˆæœ¬ã€‚

è¯¥ç»„ä»¶è‡ªåŠ¨è¿‡æ»¤å˜é‡æ ‘ï¼Œåªæ˜¾ç¤ºæ•°ç»„ç±»å‹çš„å˜é‡ï¼Œå¹¶è‡ªåŠ¨è®¾å®š[ç§æœ‰ä½œç”¨åŸŸ](../../guide/variable/concept#èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ)ï¼Œå¸¸ç”¨äºæ‰¹å¤„ç†åœºæ™¯ï¼ˆå¦‚ Loop èŠ‚ç‚¹çš„å¾ªç¯æ•°æ®æºé€‰æ‹©ï¼‰ã€‚

**æ ¸å¿ƒç‰¹æ€§ï¼š**

- ğŸ” **è‡ªåŠ¨è¿‡æ»¤**ï¼šåªæ˜¾ç¤ºæ•°ç»„ç±»å‹ï¼ˆ`type: 'array'`ï¼‰çš„å˜é‡ã€‚
- ğŸ” **ç§æœ‰ä½œç”¨åŸŸ**ï¼šé€šè¿‡ [`PrivateScopeProvider`](../../guide/variable/concept#èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ) æä¾›ç‹¬ç«‹çš„å˜é‡ä½œç”¨åŸŸã€‚
- ğŸ¯ **ä¸“ç”¨åœºæ™¯**ï¼šä¸“ä¸ºæ‰¹å¤„ç†ã€å¾ªç¯ç­‰éœ€è¦æ•°ç»„æ•°æ®æºçš„åœºæ™¯è®¾è®¡ã€‚

## æ¡ˆä¾‹æ¼”ç¤º

### åŸºæœ¬ä½¿ç”¨

<BasicStory />

```tsx pure title="form-meta.tsx"
import { BatchVariableSelector, VariableSelector } from '@flowgram.ai/form-materials';

const formMeta = {
  render: () => (
    <>
      <FormHeader />
      {/* BatchVariableSelector åªæ˜¾ç¤ºæ•°ç»„ç±»å‹å˜é‡ */}
      <Field<string[] | undefined> name="batch_variable">
        {({ field }) => (
          <BatchVariableSelector
            value={field.value}
            onChange={(value) => field.onChange(value)}
          />
        )}
      </Field>

      {/* VariableSelector æ˜¾ç¤ºæ‰€æœ‰ç±»å‹å˜é‡ */}
      <Field<string[] | undefined> name="normal_variable">
        {({ field }) => (
          <VariableSelector
            value={field.value}
            onChange={(value) => field.onChange(value)}
          />
        )}
      </Field>
    </>
  ),
}
```

## API å‚è€ƒ

### BatchVariableSelector Props

BatchVariableSelector ç»§æ‰¿äº† [VariableSelector](./variable-selector) çš„æ‰€æœ‰å±æ€§ï¼Œä½† `includeSchema` å±æ€§å·²è¢«å›ºå®šä¸ºæ•°ç»„ç±»å‹è¿‡æ»¤ï¼Œæ— æ³•è‡ªå®šä¹‰ã€‚

| å±æ€§å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| `value` | `string[]` | - | é€‰ä¸­çš„å˜é‡è·¯å¾„æ•°ç»„ |
| `onChange` | `(value?: string[]) => void` | - | å˜é‡é€‰æ‹©å˜åŒ–æ—¶çš„å›è°ƒå‡½æ•° |
| `config` | `VariableSelectorConfig` | `{}` | é…ç½®å¯¹è±¡ï¼ˆåŒ VariableSelectorï¼‰ |
| `readonly` | `boolean` | `false` | æ˜¯å¦ä¸ºåªè¯»æ¨¡å¼ |
| `hasError` | `boolean` | `false` | æ˜¯å¦æ˜¾ç¤ºé”™è¯¯çŠ¶æ€ |
| `style` | `React.CSSProperties` | - | è‡ªå®šä¹‰æ ·å¼ |
| `triggerRender` | `(props: TriggerRenderProps) => React.ReactNode` | - | è‡ªå®šä¹‰è§¦å‘å™¨æ¸²æŸ“ |

:::warning
`includeSchema` å’Œ `excludeSchema` å±æ€§åœ¨ BatchVariableSelector ä¸­ä¸å¯ç”¨ï¼Œå› ä¸ºç»„ä»¶å†…éƒ¨å·²å›ºå®šä½¿ç”¨ `{ type: 'array', extra: { weak: true } }` ä½œä¸ºè¿‡æ»¤æ¡ä»¶ã€‚
:::

### VariableSelectorConfig

| å±æ€§å | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| `placeholder` | `string` | `'é€‰æ‹©å˜é‡'` | å ä½ç¬¦æ–‡æœ¬ |
| `notFoundContent` | `string` | `'æœªå®šä¹‰'` | å˜é‡æœªæ‰¾åˆ°æ—¶çš„æ˜¾ç¤ºå†…å®¹ |

## æºç å¯¼è¯»

<SourceCode
  href="https://github.com/bytedance/flowgram.ai/tree/main/packages/materials/form-materials/src/components/batch-variable-selector"
/>

ä½¿ç”¨ CLI å‘½ä»¤å¯ä»¥å¤åˆ¶æºä»£ç åˆ°æœ¬åœ°ï¼š

```bash
npx @flowgram.ai/cli@latest materials components/batch-variable-selector
```

### ç›®å½•ç»“æ„è®²è§£

```
batch-variable-selector/
â””â”€â”€ index.tsx           # ä¸»ç»„ä»¶å®ç°ï¼ŒåŒ…å« BatchVariableSelector æ ¸å¿ƒé€»è¾‘
```

### æ ¸å¿ƒå®ç°è¯´æ˜

#### ç§æœ‰ä½œç”¨åŸŸæœºåˆ¶

BatchVariableSelector é€šè¿‡ `PrivateScopeProvider` ä¸ºå­ç»„ä»¶æä¾›ç‹¬ç«‹çš„å˜é‡ä½œç”¨åŸŸï¼š

```tsx
<PrivateScopeProvider>
  <VariableSelector {...props} includeSchema={batchVariableSchema} />
</PrivateScopeProvider>
```

`PrivateScopeProvider` ä¼šåˆ›å»ºä¸€ä¸ª[èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ](../../guide/variable/concept#èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ)ï¼Œè¿™åœ¨æ‰¹å¤„ç†åœºæ™¯ä¸­éå¸¸é‡è¦ï¼š

- **å¾ªç¯å˜é‡éš”ç¦»**ï¼šåœ¨ Loop èŠ‚ç‚¹ä¸­ï¼Œæ¯æ¬¡è¿­ä»£çš„å¾ªç¯å˜é‡ï¼ˆå¦‚ `item`ã€`index`ï¼‰éƒ½å­˜å‚¨åœ¨ç§æœ‰ä½œç”¨åŸŸä¸­ï¼Œé¿å…æ±¡æŸ“å¤–éƒ¨ä½œç”¨åŸŸ
- **é¿å…å‘½åå†²çª**ï¼šæ‰¹å¤„ç†èŠ‚ç‚¹å†…éƒ¨å®šä¹‰çš„ä¸´æ—¶å˜é‡ä¸ä¼šä¸å¤–éƒ¨å˜é‡äº§ç”Ÿå‘½åå†²çª
- **æ”¯æŒåµŒå¥—ç»“æ„**ï¼šå¤æ‚çš„æ‰¹å¤„ç†é€»è¾‘å¯ä»¥åœ¨ç§æœ‰ä½œç”¨åŸŸä¸­å®šä¹‰å¤šå±‚å˜é‡ç»“æ„
- **æ•°æ®å®‰å…¨**ï¼šç§æœ‰ä½œç”¨åŸŸä¸­çš„å˜é‡åªèƒ½è¢«å½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹è®¿é—®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§

:::info

æ›´å¤šå…³äºä½œç”¨åŸŸçš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒ[å˜é‡æ¦‚å¿µæ–‡æ¡£](../../guide/variable/concept#ç”»å¸ƒä¸­çš„å˜é‡)ã€‚

:::

#### æ•°ç»„ç±»å‹è¿‡æ»¤

ç»„ä»¶å†…éƒ¨å›ºå®šä½¿ç”¨ä»¥ä¸‹ schema è¿›è¡Œè¿‡æ»¤ï¼š

```typescript
const batchVariableSchema: IJsonSchema = {
  type: 'array',
  extra: { weak: true },
};
```

- `type: 'array'`ï¼šåªæ˜¾ç¤ºæ•°ç»„ç±»å‹çš„å˜é‡
- `extra: { weak: true }`ï¼šå¯ç”¨å¼±ç±»å‹åŒ¹é…ï¼Œå…è®¸åŒ¹é…å¯èƒ½å…¼å®¹çš„ç±»å‹

### æ•´ä½“æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant BatchVariableSelector
    participant PrivateScopeProvider
    participant VariableSelector
    participant useVariableTree
    participant VariableTree

    User->>BatchVariableSelector: é€‰æ‹©æ•°ç»„å˜é‡
    BatchVariableSelector->>PrivateScopeProvider: è®¾å®šç§æœ‰ä½œç”¨åŸŸä¸Šä¸‹æ–‡
    PrivateScopeProvider->>VariableSelector: ä¼ é€’åŒ…å«æ•°ç»„è¿‡æ»¤çš„ schema
    VariableSelector->>useVariableTree: è·å–å¯ç”¨å˜é‡åˆ—è¡¨
    useVariableTree->>VariableTree: æŸ¥è¯¢å˜é‡æ ‘æ•°æ®
    VariableTree-->>useVariableTree: è¿”å›æ‰€æœ‰å˜é‡
    useVariableTree-->>VariableSelector: è¿‡æ»¤å‡ºæ•°ç»„ç±»å‹å˜é‡
    VariableSelector-->>BatchVariableSelector: æ¸²æŸ“æ•°ç»„å˜é‡é€‰æ‹©å™¨
    BatchVariableSelector-->>User: æ˜¾ç¤ºå¯é€‰çš„æ•°ç»„å˜é‡
```

### ä½¿ç”¨åˆ°çš„ FlowGram API

[**@flowgram.ai/editor**](https://github.com/bytedance/flowgram.ai/tree/main/packages/plugins/node-variable-plugin)
- [`PrivateScopeProvider`](https://flowgram.ai/auto-docs/node-variable-plugin/functions/PrivateScopeProvider): æä¾›ç§æœ‰å˜é‡ä½œç”¨åŸŸçš„ Context Provider

[**@flowgram.ai/json-schema**](https://github.com/bytedance/flowgram.ai/tree/main/packages/variable/json-schema)
- [`IJsonSchema`](https://flowgram.ai/auto-docs/json-schema/interfaces/IJsonSchema): JSON Schema ç±»å‹å®šä¹‰ï¼Œç”¨äºå˜é‡ç±»å‹è¿‡æ»¤

### ä¾èµ–çš„å…¶ä»–ç‰©æ–™

[**VariableSelector**](./variable-selector) å˜é‡é€‰æ‹©å™¨åŸºç¡€ç»„ä»¶
- `VariableSelector`: æ ¸å¿ƒå˜é‡é€‰æ‹©ç»„ä»¶ï¼ŒBatchVariableSelector æ˜¯å…¶å°è£…ç‰ˆæœ¬
- `VariableSelectorProps`: å±æ€§ç±»å‹å®šä¹‰

## å¸¸è§é—®é¢˜

### ä¸ºä»€ä¹ˆéœ€è¦ PrivateScopeProviderï¼Ÿ

`PrivateScopeProvider` æä¾›äº†å˜é‡ä½œç”¨åŸŸéš”ç¦»æœºåˆ¶ï¼Œåœ¨ä»¥ä¸‹åœºæ™¯ä¸­éå¸¸é‡è¦ï¼š

1. **å¾ªç¯èŠ‚ç‚¹**ï¼šåœ¨ Loop èŠ‚ç‚¹ä¸­ï¼Œæ¯æ¬¡è¿­ä»£éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„ä½œç”¨åŸŸæ¥å­˜å‚¨å¾ªç¯å˜é‡ï¼ˆå¦‚ `item`, `index`ï¼‰ã€‚å‚è€ƒ[å˜é‡æ¦‚å¿µ - èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ](../../guide/variable/concept#èŠ‚ç‚¹ç§æœ‰ä½œç”¨åŸŸ)
2. **åµŒå¥—ç»“æ„**ï¼šå½“èŠ‚ç‚¹å†…éƒ¨æœ‰åµŒå¥—çš„å˜é‡å£°æ˜æ—¶ï¼Œé¿å…ä¸å¤–éƒ¨å˜é‡äº§ç”Ÿå‘½åå†²çª
3. **ç»„ä»¶å¤ç”¨**ï¼šç›¸åŒçš„ç»„ä»¶åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨æ—¶ï¼Œç¡®ä¿å˜é‡ä¸ä¼šäº’ç›¸å¹²æ‰°
4. **æ•°æ®å®‰å…¨**ï¼šç§æœ‰ä½œç”¨åŸŸä¸­çš„å˜é‡åªèƒ½è¢«å½“å‰èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹è®¿é—®ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ€§

æ›´å¤šå…³äºä½œç”¨åŸŸé“¾å’Œå˜é‡è®¿é—®æƒé™çš„ä¿¡æ¯ï¼Œè¯·å‚è€ƒ[å˜é‡æ¦‚å¿µ - ä½œç”¨åŸŸé“¾](../../guide/variable/concept#ä½œç”¨åŸŸé“¾)ã€‚

### BatchVariableSelector ä¸ VariableSelector çš„åŒºåˆ«ï¼Ÿ

| ç‰¹æ€§ | BatchVariableSelector | VariableSelector |
|------|----------------------|------------------|
| å˜é‡ç±»å‹è¿‡æ»¤ | å›ºå®šä¸ºæ•°ç»„ç±»å‹ | å¯è‡ªå®šä¹‰ |
| ä½œç”¨åŸŸ | è‡ªå¸¦ç§æœ‰ä½œç”¨åŸŸ | ä½¿ç”¨å½“å‰ä½œç”¨åŸŸ |
| ä½¿ç”¨åœºæ™¯ | æ‰¹å¤„ç†ã€å¾ªç¯ç­‰ | é€šç”¨å˜é‡é€‰æ‹© |
| Schema é…ç½® | ä¸å¯é…ç½® | å®Œå…¨å¯é…ç½® |

### å¦‚ä½•è·å–é€‰ä¸­å˜é‡çš„å®é™…å€¼ï¼Ÿ

BatchVariableSelector è¿”å›çš„æ˜¯å˜é‡è·¯å¾„ï¼ˆ`string[]`ï¼‰ï¼Œå¦‚éœ€è·å–å®é™…å€¼ï¼Œéœ€è¦åœ¨è¡¨å•çš„ effect ä¸­é…åˆ [`provideBatchInputEffect`](../effects/provide-batch-input) ä½¿ç”¨ï¼š

```typescript
export const formMeta = {
  render: YourFormRender,
  effect: {
    yourFieldName: provideBatchInputEffect,
  },
};
```

`provideBatchInputEffect` ä¼šè‡ªåŠ¨è§£æå˜é‡å¼•ç”¨å¹¶æ³¨å…¥åˆ°è¡¨å•æ•°æ®ä¸­ã€‚
